# ğŸ“Œ ì»´íŒŒì¼ëŸ¬ ì„¤ì •
CC = gcc          # C ì»´íŒŒì¼ëŸ¬
CXX = g++         # C++ ì»´íŒŒì¼ëŸ¬
CFLAGS = -std=c11 -Wall -Wextra -O2 -Iinclude -lpthread -ldl -lrt -liconv
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -Iinclude -lpthread -ldl -lrt 

# ğŸ“Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë””ë ‰í† ë¦¬ ì„¤ì •
LIB_DIR = /home/doogunwo/tokenizers/tokenizers/tokenizers-cpp/build
LIBS = -L$(LIB_DIR) -ltokenizers_cpp -ltokenizers_c -lpthread -ldl -ljansson

# ğŸ“Œ ë””ë ‰í† ë¦¬ ì„¤ì •
SRC_DIR = src
OBJ_DIR = bin/obj
BIN_DIR = bin

# ğŸ“Œ ì†ŒìŠ¤ íŒŒì¼ ëª©ë¡
C_SRCS = $(wildcard $(SRC_DIR)/*.c)
CPP_SRCS = $(wildcard $(SRC_DIR)/*.cpp)

# ğŸ“Œ `ioctl_host.cpp`ë¥¼ ì§„ì…ì (main í¬í•¨)ìœ¼ë¡œ ì„¤ì •
MAIN_SRC = $(SRC_DIR)/ioctl_host.cpp

# ğŸ“Œ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ëª©ë¡ (MAIN_SRC ì œì™¸)
C_OBJS = $(patsubst $(SRC_DIR)/%.c, $(OBJ_DIR)/%.o, $(filter-out $(MAIN_SRC), $(C_SRCS)))
CPP_OBJS = $(patsubst $(SRC_DIR)/%.cpp, $(OBJ_DIR)/%.o, $(filter-out $(MAIN_SRC), $(CPP_SRCS)))

# ğŸ“Œ ì‹¤í–‰ íŒŒì¼
TARGET = $(BIN_DIR)/bpe_process_cpp

# ğŸ“Œ ê¸°ë³¸ ë¹Œë“œ íƒ€ê²Ÿ
all: $(TARGET)

# ğŸ“Œ ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ ê·œì¹™ (`ioctl_host.cpp`ì„ ë©”ì¸ìœ¼ë¡œ)
$(TARGET): $(C_OBJS) $(CPP_OBJS) $(OBJ_DIR)/ioctl_host.o
	mkdir -p $(BIN_DIR)
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS)  # `g++` ì‚¬ìš©í•˜ì—¬ ë§í¬

# ğŸ“Œ ê°œë³„ C ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ë¹Œë“œ ê·œì¹™
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c | $(OBJ_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

# ğŸ“Œ ê°œë³„ C++ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ë¹Œë“œ ê·œì¹™
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	$(CXX) $(CXXFLAGS) -c $< -o $@

# ğŸ“Œ `ioctl_host.cpp` ë¹Œë“œ (ë©”ì¸ ì‹¤í–‰ íŒŒì¼)
$(OBJ_DIR)/ioctl_host.o: $(SRC_DIR)/ioctl_host.cpp | $(OBJ_DIR)
	$(CXX) $(CXXFLAGS) -c $< -o $@

# ğŸ“Œ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„±
$(OBJ_DIR):
	mkdir -p $(OBJ_DIR)

# ğŸ“Œ í´ë¦°ì—… (ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ë° ì‹¤í–‰ íŒŒì¼ ì œê±°)
clean:
	rm -rf $(OBJ_DIR) $(BIN_DIR)/bpe_process

# ğŸ“Œ ê³µìœ  ë©”ëª¨ë¦¬ ì‚­ì œ (ë””ë²„ê¹…ì„ ìœ„í•œ ì¶”ê°€ ëª…ë ¹ì–´)
clean_shm:
	ipcrm -M 5678
	ipcrm -M 5679
